# Offline Till Closing - Visual Guide

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    POS TILL CLOSING SYSTEM                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         STAFF UI
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  CloseTillModal  â”‚
                    â”‚  - Show OFFLINE  â”‚
                    â”‚  - Input counts  â”‚
                    â”‚  - Submit close  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Check isOnline?  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                         â”‚         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                     â”‚
       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ ONLINE PATH â”‚                    â”‚ OFFLINE PATH  â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
            â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                              â”‚ saveTillClose   â”‚
            â”‚                              â”‚ Offline()       â”‚
            â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ POST /api/till   â”‚            â”‚ IndexedDB Store    â”‚
       â”‚ /close           â”‚            â”‚ till_closes        â”‚
       â”‚ (Online)         â”‚            â”‚ synced: false      â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
            â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                              â”‚ Redirect Login  â”‚
            â”‚                              â”‚ (both paths)    â”‚
            â”‚                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                     â”‚
       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
       â”‚ Server processes  â”‚                     â”‚
       â”‚ - Update Till     â”‚                     â”‚
       â”‚ - Create Report   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
       â”‚ - Return success  â”‚         â”‚           â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
            â”‚                   â”‚ DEVICE OFFLINE    â”‚
            â”‚                   â”‚ (no sync yet)     â”‚
            â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â”‚                        â”‚ Device comes online
            â”‚                        â”‚ (network restored)
            â”‚                        â”‚
            â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚ Window 'online'   â”‚
            â”‚                   â”‚ event fires       â”‚
            â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚ syncPendingTillClosesâ”‚
            â”‚                   â”‚ (auto-triggered)     â”‚
            â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚ Fetch from IndexedDB â”‚
            â”‚                   â”‚ synced: false        â”‚
            â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â”‚                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                   â”‚ POST /api/till/close â”‚
            â”‚                   â”‚ (same as online)     â”‚
            â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Server processes  â”‚
                   â”‚ (same as online)  â”‚
                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Mark synced: true     â”‚
                   â”‚ in IndexedDB          â”‚
                   â”‚ syncedAt: timestamp   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow Timeline

```
TIME: 0s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â””â”€ OFFLINE (Network Down)
         Staff opens till, adds transactions

TIME: 5s
      â””â”€ Staff clicks "Close Till"
         System detects: isOnline = false
         Shows: "OFFLINE" badge + message

TIME: 7s
      â””â”€ Staff enters physical tender counts
         e.g., Cash: 50000, Card: 25000

TIME: 10s
      â””â”€ Staff clicks "Close Till" button
         Validation passes (all tenders have values)

TIME: 11s
      â””â”€ saveTillCloseOffline() called
         Opens IndexedDB 'SalesPOS' database
         Gets till_closes object store

TIME: 12s
      â””â”€ Till close data saved to IndexedDB
         Sets synced: false
         Records savedAt: Date
         Console: "ğŸ’¾ Till close saved to IndexedDB"

TIME: 13s
      â””â”€ logout() clears staff context
         Redirect to "/staff-login" initiated

TIME: 15s
      â””â”€ Staff logged out, at login screen
         Till close safely stored locally

TIME: 15s - 2 hours (OFFLINE PERIOD)
      â””â”€ Device offline, no network activity
         Data remains in IndexedDB
         No sync attempts

TIME: 2h 15m â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â””â”€ ONLINE (Network Restored)
         Device connects to network
         navigator.onLine = true

TIME: 2h 15.1m
      â””â”€ Window 'online' event fires automatically
         initOfflineSync() listener triggered

TIME: 2h 15.2m
      â””â”€ syncPendingTillCloses() called
         Console: "ğŸŸ¢ Online - Syncing queued..."

TIME: 2h 15.3m
      â””â”€ Open IndexedDB till_closes store
         Query: WHERE synced = false
         Found 1 pending till close

TIME: 2h 15.4m
      â””â”€ Retrieve till close data from IndexedDB
         Data: { _id: "till_id", tenderCounts: {...}, ... }
         Console: "ğŸ”„ Syncing till close: till_id"

TIME: 2h 15.5m
      â””â”€ POST /api/till/close to server
         Headers: Content-Type: application/json
         Body: { tillId, tenderCounts, closingNotes, summary }

TIME: 2h 15.7m
      â””â”€ Server receives request
         Find Till by ID
         Update Till with tender counts & notes

TIME: 2h 15.8m
      â””â”€ Server creates EndOfDay report
         Links to Till
         Records reconciliation data

TIME: 2h 15.9m
      â””â”€ Server returns response
         { success: true, till: {...}, endOfDay: {...} }

TIME: 2h 16.0m
      â””â”€ Response received and parsed
         response.ok = true
         Console: "âœ… Till close synced: till_id"

TIME: 2h 16.1m
      â””â”€ Call markTillCloseSynced(till_id)
         Update IndexedDB record
         Set synced: true
         Set syncedAt: Date

TIME: 2h 16.2m
      â””â”€ Update complete
         Console: "âœ… Till closes sync complete: 1 synced"
         Till close permanently synced

TIME: 2h 16.3m
      â””â”€ COMPLETE
         All data synchronized
         Staff can proceed normally
```

## Component Interaction Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      STAFF LOGIN PAGE                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†‘
                     (redirects after close)
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MENU SCREEN                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ [Category List] [Product Grid] [Sync Button]              â”‚ â”‚
â”‚  â”‚                                     â†“                      â”‚ â”‚
â”‚  â”‚                            menuScreen.handleManualSync()   â”‚ â”‚
â”‚  â”‚                            - Fetch categories              â”‚ â”‚
â”‚  â”‚                            - Fetch products                â”‚ â”‚
â”‚  â”‚                            - Call syncPendingTransactions()â”‚ â”‚
â”‚  â”‚                            - Call syncPendingTillCloses()  â”‚ â”‚
â”‚  â”‚                                     â†“                      â”‚ â”‚
â”‚  â”‚                            offlineSync.js functions        â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚              â†‘                                 â†“                  â”‚
â”‚              â”‚                                 â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Open Till (RESUME)  â”‚        â”‚  Add Items to Cart        â”‚  â”‚
â”‚  â”‚ or Start New Till   â”‚        â”‚  (CartPanel)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  - Create transaction     â”‚  â”‚
â”‚              â†“                   â”‚  - Save online/offline    â”‚  â”‚
â”‚              â”‚                   â”‚  - Auto-sync if online    â”‚  â”‚
â”‚              â†“                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                                â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    CLOSE TILL MODAL               â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚ Close Till & Reconciliation â”‚  â”‚
                    â”‚  â”‚ [OFFLINE Badge - if offline]â”‚  â”‚
                    â”‚  â”‚                             â”‚  â”‚
                    â”‚  â”‚ Till Info:                  â”‚  â”‚
                    â”‚  â”‚ - Session time              â”‚  â”‚
                    â”‚  â”‚ - Transaction count         â”‚  â”‚
                    â”‚  â”‚ - [Offline info message]    â”‚  â”‚
                    â”‚  â”‚                             â”‚  â”‚
                    â”‚  â”‚ Summary:                    â”‚  â”‚
                    â”‚  â”‚ - Expected Total            â”‚  â”‚
                    â”‚  â”‚ - Actual Total (from txns)  â”‚  â”‚
                    â”‚  â”‚ - Variance                  â”‚  â”‚
                    â”‚  â”‚                             â”‚  â”‚
                    â”‚  â”‚ Tender Reconciliation:      â”‚  â”‚
                    â”‚  â”‚ [Input boxes for each]      â”‚  â”‚
                    â”‚  â”‚ - Cash:     [_____]         â”‚  â”‚
                    â”‚  â”‚ - Card:     [_____]         â”‚  â”‚
                    â”‚  â”‚ - Cheque:   [_____]         â”‚  â”‚
                    â”‚  â”‚                             â”‚  â”‚
                    â”‚  â”‚ Closing Notes:              â”‚  â”‚
                    â”‚  â”‚ [Text area]                 â”‚  â”‚
                    â”‚  â”‚                             â”‚  â”‚
                    â”‚  â”‚ [Close Till] [Cancel]       â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Check isOnline?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
                     â”‚         â”‚
                ONLINE       OFFLINE
                  â”‚             â”‚
            â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ POST API â”‚   â”‚ IndexedDB     â”‚
            â”‚ Response â”‚   â”‚ till_closes   â”‚
            â”‚ OK âœ“     â”‚   â”‚ synced: false â”‚
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚            â”‚
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Redirect to Login â”‚
                  â”‚ (both paths)      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## IndexedDB Storage Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        IndexedDB Database: SalesPOS (v1)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  Object Stores:                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                     â”‚
â”‚  ğŸ“¦ products                                        â”‚
â”‚     Key: _id                                       â”‚
â”‚     Data: Product documents                        â”‚
â”‚                                                     â”‚
â”‚  ğŸ“¦ categories                                      â”‚
â”‚     Key: _id                                       â”‚
â”‚     Data: Category documents                       â”‚
â”‚                                                     â”‚
â”‚  ğŸ“¦ transactions                                    â”‚
â”‚     Key: id (auto-increment)                       â”‚
â”‚     Indexes: synced, createdAt                     â”‚
â”‚     Data: Transaction records (online/offline)    â”‚
â”‚                                                     â”‚
â”‚  ğŸ“¦ sync_meta                                       â”‚
â”‚     Key: key                                       â”‚
â”‚     Data: Sync metadata                            â”‚
â”‚                                                     â”‚
â”‚  ğŸ“¦ till_closes â† NEW!                              â”‚
â”‚     Key: _id (Till ID)                             â”‚
â”‚     Indexes: synced, closedAt                      â”‚
â”‚     Data: {                                        â”‚
â”‚       _id: "507f...",                             â”‚
â”‚       staffId: "staff_123",                       â”‚
â”‚       locationId: "loc_456",                      â”‚
â”‚       tenderCounts: { cash: 50000, ... },        â”‚
â”‚       closingNotes: "All verified",              â”‚
â”‚       summary: { expectedTotal: 75000, ... },    â”‚
â”‚       synced: false,  â† Tracks pending syncs     â”‚
â”‚       savedAt: Date,   â† Local save time         â”‚
â”‚       syncedAt: null   â† Server sync time        â”‚
â”‚     }                                             â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Console Output Timeline

```
SCENARIO: Close Till Offline, Then Come Online

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OFFLINE (Network Down)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚ [14:32:45.123] ğŸ“´ Offline detected in CloseTillModal    â”‚
â”‚ [14:32:47.456] âœ… Validation passed - all tenders OK    â”‚
â”‚ [14:32:49.789] ğŸ“‹ Close till payload: {...}            â”‚
â”‚ [14:32:50.012] ğŸ’¾ Till close saved to IndexedDB: ...   â”‚
â”‚ [14:32:50.345] âœ… Till close saved offline - will sync  â”‚
â”‚ [14:32:50.678] ğŸ“Š Till reconciliation saved locally     â”‚
â”‚ [14:32:51.901] ğŸ”„ Redirecting to login...              â”‚
â”‚ [14:32:52.234] âœ… Redirected to login                   â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[15 minutes to 2 hours - OFFLINE PERIOD - NO LOGS]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ONLINE (Network Restored)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚ [16:47:23.456] ğŸŸ¢ Online - Syncing queued transactions  â”‚
â”‚ [16:47:23.789] ğŸŸ¢ Online - Syncing queued till closes   â”‚
â”‚ [16:47:23.912] â„¹ï¸ No pending transactions to sync       â”‚
â”‚ [16:47:24.045] ğŸ”„ Syncing 1 pending till closes...     â”‚
â”‚ [16:47:24.178] ğŸ”„ Syncing till close: 507f1f...       â”‚
â”‚ [16:47:24.501] ğŸ“¤ Sending till ID to API: "507f1f..."  â”‚
â”‚ [16:47:24.834] ğŸ“‹ Close till response status: 200      â”‚
â”‚ [16:47:25.067] âœ… Till closed response: {...}          â”‚
â”‚ [16:47:25.200] âœ… Till close synced: 507f1f...        â”‚
â”‚ [16:47:25.433] âœ… Till closes sync complete: 1 synced  â”‚
â”‚ [16:47:25.766] âœ… Marked till close as synced:507f1f...â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Machine Diagram

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Till Closed  â”‚
                    â”‚ Redirected   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                   â”‚
         â–¼                                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ONLINE     â”‚              â”‚    OFFLINE     â”‚
    â”‚ API Response â”‚              â”‚ IndexedDB Save â”‚
    â”‚   Success    â”‚              â”‚  (synced:false)â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Await Network Recovery    â”‚
         â”‚                    â”‚ (no timeout, indefinite) â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                            â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                            â”‚ Device Online â”‚
         â”‚                            â”‚ (event fires) â”‚
         â”‚                            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚ syncPendingTill    â”‚
         â”‚                        â”‚ Closes() starts    â”‚
         â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚ POST to API        â”‚
         â”‚                       â”‚ (same endpoint)    â”‚
         â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚ API Response OK?   â”‚
         â”‚                       â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       yesâ”‚ no
         â”‚                          â”‚  â”‚
         â”‚                          â–¼  â”‚
         â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                    â”‚ Log Error,       â”‚
         â”‚                    â”‚ Retry on next    â”‚
         â”‚                    â”‚ sync attempt     â”‚
         â”‚                    â”‚ (stays pending)  â”‚
         â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                  â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Mark Synced  â”‚
    â”‚ syncedAt set â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Complete - Till  â”‚
    â”‚ Close Persisted  â”‚
    â”‚ on Server        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Sync Decision Tree

```
                        Till Close Initiated
                               â”‚
                               â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Check Online?â”‚
                        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
                          YES       NO
                           â”‚         â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Online â”‚  â”‚  Offline   â”‚
                    â”‚  Path  â”‚  â”‚   Path     â”‚
                    â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚             â”‚
                   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ POST API â”‚  â”‚ Check IndexedDB? â”‚
                   â”‚ Success? â”‚  â”‚ Storage OK?      â”‚
                   â””â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
                  YES NO        YES   NO
                    â”‚  â”‚         â”‚      â”‚
                    â”‚  â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”   â”‚
                    â”‚  â”‚    â”‚Store â”‚   â”‚
                    â”‚  â”‚    â”‚Data  â”‚   â”‚
                    â”‚  â”‚    â””â”€â”€â”€â”¬â”€â”€â”˜   â”‚
                    â”‚  â”‚        â”‚      â”‚
                    â”‚  â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”
                    â”‚  â”‚   â”‚ Log Error    â”‚
                    â”‚  â”‚   â”‚ Show Message â”‚
                    â”‚  â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  â”‚        â”‚
                    â”‚  â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  â”‚   â”‚ Retry Pending â”‚
                    â”‚  â”‚   â”‚ (on network)  â”‚
                    â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚  â”‚
                    â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Mark Synced:    â”‚  â”‚ User Retry  â”‚
                        â”‚ true            â”‚  â”‚ Manual Sync â”‚
                        â”‚ syncedAt set    â”‚  â”‚ Button      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ COMPLETE - TILL  â”‚
                        â”‚ CLOSE SYNCED     â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Visual Guide Complete**
Use these diagrams to understand the offline till closing flow!
